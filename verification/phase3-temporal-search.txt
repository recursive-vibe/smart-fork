PHASE 3 - TEMPORAL SEARCH FILTERS (P2)
2026-01-21

TASK: Add temporal search filters
- Allow users to filter sessions by time ranges
- Support predefined ranges (today, this_week, last_month, etc.)
- Parse natural language dates ("last Tuesday", "2 weeks ago")
- Add recency boost for temporal queries
- Expose via MCP fork-detect tool

=== FILES ADDED ===

1. src/smart_fork/temporal_filter.py
   - TemporalFilter class with static methods
   - parse_time_range(): Parses predefined & natural language time expressions
   - filter_by_timestamp(): Checks if timestamp falls within range
   - calculate_recency_boost(): Calculates boost based on recency

2. tests/test_temporal_filter.py
   - 40 comprehensive tests covering all temporal filter functionality
   - Tests for predefined ranges, relative time, weekdays, custom ranges
   - Edge cases and error handling

=== FILES MODIFIED ===

1. src/smart_fork/search_service.py
   - Added time_range, start_date, end_date parameters to search()
   - Added apply_recency_boost parameter (default True)
   - Added _filter_sessions_by_time() helper method
   - Updated _calculate_session_scores() to apply recency boost
   - Cache key includes temporal parameters

2. src/smart_fork/server.py
   - Updated fork_detect_handler to accept temporal parameters
   - Updated fork-detect tool schema with time_range, start_date, end_date

3. tests/test_api_server.py
   - Fixed SessionScore instantiation (added preference_boost)

4. tests/test_mcp_integration.py
   - Fixed SessionScore instantiations (added preference_boost)

5. tests/test_search_service.py
   - Fixed SessionScore instantiation (added preference_boost)

=== FEATURES IMPLEMENTED ===

## Predefined Time Ranges
- today: From midnight to now
- yesterday: Yesterday's full day
- this_week: From this Monday to now
- last_week: Previous Monday to Sunday
- this_month: From 1st of month to now
- last_month: Previous month's full span
- this_year: From January 1st to now

## Natural Language Parsing
- Relative time: "2 hours ago", "5 days ago", "3 weeks ago", "2 months ago"
- Short format: "2h", "5d", "3w", "1m"
- Weekdays: "last Monday", "last Tuesday", etc. (with variations)

## ISO Date Support
- Full dates: "2026-01-15"
- Datetimes: "2026-01-15T10:30:00"
- Custom ranges: start_date and end_date parameters

## Recency Boost
- Linear decay from max_boost (0.2) to 0 over decay_days (30)
- Applied when temporal filtering is active
- Combined with preference boost from Phase 3 P2 feature

=== VERIFICATION ===

## Unit Tests
$ pytest tests/test_temporal_filter.py -v
40 tests passed - all temporal filter functionality verified

## Integration Tests
$ pytest tests/test_search_service.py tests/test_mcp_integration.py -v
40 tests passed - no regressions, temporal integration working

## Test Coverage
- Time range parsing: 7 tests
- Relative time parsing: 5 tests
- Weekday parsing: 3 tests
- Custom date ranges: 4 tests
- Timestamp filtering: 6 tests
- Recency boost: 9 tests
- Edge cases: 6 tests

=== EXAMPLE USAGE ===

Via MCP tool:
```
fork-detect(
  query="user authentication",
  time_range="this_week"
)
```

```
fork-detect(
  query="React hooks",
  time_range="last Tuesday"
)
```

```
fork-detect(
  query="API design",
  time_range="2 weeks ago"
)
```

```
fork-detect(
  query="database optimization",
  start_date="2026-01-01",
  end_date="2026-01-15"
)
```

Via SearchService:
```python
results = search_service.search(
    query="authentication",
    time_range="this_week",
    apply_recency_boost=True
)
```

=== IMPLEMENTATION NOTES ===

1. Temporal filtering happens after vector search but before ranking
   - Vector search returns top 200 chunks
   - Chunks grouped by session
   - Sessions filtered by timestamp
   - Remaining sessions scored and ranked

2. Recency boost is additive with preference boost
   - preference_boost: Based on user's past selections
   - recency_boost: Based on session age (if temporal filtering active)
   - Combined: preference_boost + recency_boost
   - Passed to ScoringService.calculate_session_score()

3. Cache keys include temporal parameters
   - Ensures different time ranges get separate cache entries
   - Format: {'_temporal_start': ISO, '_temporal_end': ISO}

4. Timestamps use SessionMetadata fields
   - Primary: last_modified
   - Fallback: created_at
   - Sessions without timestamps are excluded from temporal results

=== BACKWARDS COMPATIBILITY ===

- All new parameters are optional
- Existing searches continue to work unchanged
- Tests updated to include preference_boost=0.0 for SessionScore

=== FUTURE ENHANCEMENTS ===

Potential improvements for future iterations:
- More natural language patterns ("next week", "two days from now")
- Timezone-aware filtering
- Recency boost configuration via settings
- Temporal range statistics in search results
- Session age distribution visualization

=== STATUS ===

✅ Implementation complete
✅ Tests passing (40 new + 40 existing)
✅ No regressions
✅ MCP integration working
✅ Documentation complete

READY FOR COMMIT
